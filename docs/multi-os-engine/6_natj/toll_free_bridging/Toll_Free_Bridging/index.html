

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toll-Free Bridging &mdash; Multi-OS Engine Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" href="../../../../_static/theme.css" type="text/css" />

  
      <script src="../../../../_static/documentation_options.js?v=cebfb12b"></script>
      <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../search/" />
    <link rel="next" title="Creating a Database App" href="../../../7_creating_db_app/creating_db_app/" />
    <link rel="prev" title="Working with Pointers" href="../../working_with_pointers/Working_With_Pointers/" />
     
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75001976-1', 'auto');
  ga('send', 'pageview');

</script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../" class="icon icon-home">
            Multi-OS Engine Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../MultiOSEngine/">Multi-OS Engine</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../1_Overview/Overview/">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../2_Introduction/Introduction/">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../3_getting_started/Getting_Started/">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../4_create_ui/create_ui/">Creating Your App’s User Interface (UI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../5_using_thirdparty/using_thirdparty/">Using Third Party Native Libraries for iOS*</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../NatJ/">Nat/J library for Java to native binding</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../natj_interoperability/NatJ_Interoperability/">Nat/J: Interoperability with Native Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../natjgen_binding_generator/NatJGen_Binding_Generator/">Nat/J Binding Generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../working_with_pointers/Working_With_Pointers/">Working with Pointers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Toll-Free Bridging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#objective-c-to-c">Objective-C to C</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-to-objective-c">C to Objective-C</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-to-c">C to C</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference external" href="https://www.noisyfox.io/moe-native-types.html">Working with Native Types: Advanced</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../7_creating_db_app/creating_db_app/">Creating a Database App</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../8_accessWebServices/accessWebServices/">Accessing Web Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../9_game/game/">Creating a Game App</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../12_advanced/advanced/">Advanced Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../13_Troubleshooting/troubleshooting/">Troubleshooting tips</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../">Multi-OS Engine Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../MultiOSEngine/">Multi-OS Engine</a></li>
          <li class="breadcrumb-item"><a href="../../NatJ/">Nat/J library for Java to native binding</a></li>
      <li class="breadcrumb-item active">Toll-Free Bridging</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/multi-os-engine/6_natj/toll_free_bridging/Toll_Free_Bridging.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="toll-free-bridging">
<h1>Toll-Free Bridging<a class="headerlink" href="#toll-free-bridging" title="Link to this heading">¶</a></h1>
<p>Here we will explain how you can use C-based and Objective-C based APIs side-by-side and pass objects between each other. More precisely we will show some examples on how to use Multi-OS Engine’s Toll-Free bridging support. Important note here is C-based APIs have manual memory management. For better understanding on how it works, refer to Apple’s <a class="reference external" href="https://developer.apple.com/library/ios/documentation/CoreFoundation/Conceptual/CFMemoryMgmt/Concepts/Ownership.html">Ownership Policy documentation</a>.
For information about which types are bridgeable, visit <a class="reference external" href="https://developer.apple.com/library/ios/documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html#//apple_ref/doc/uid/TP40010677-SW4">this</a> document.</p>
<section id="objective-c-to-c">
<h2>Objective-C to C<a class="headerlink" href="#objective-c-to-c" title="Link to this heading">¶</a></h2>
<p>Sometimes there is a need to convert Foundation classes to CoreFoundation types. This can be done with the <code class="docutils literal notranslate"><span class="pre">ObjCRuntime.cast(from,</span> <span class="pre">toType)</span></code> method:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create an URL to intel.com and get its data</span>
<span class="n">NSURL</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NSURL</span><span class="p">.</span><span class="na">URLWithString</span><span class="p">(</span><span class="s">&quot;http://www.intel.com&quot;</span><span class="p">);</span>
<span class="n">NSData</span><span class="w"> </span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NSData</span><span class="p">.</span><span class="na">dataWithContentsOfURL</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>

<span class="c1">// Cast the NSData to a CFDataRef</span>
<span class="n">CFDataRef</span><span class="w"> </span><span class="n">cf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ObjCRuntime</span><span class="p">.</span><span class="na">cast</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="n">CFDataRef</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="c1">// Retain the data</span>
<span class="n">CFRetain</span><span class="p">(</span><span class="n">cf</span><span class="p">);</span>

<span class="c1">// Create a string from the data</span>
<span class="kt">int</span><span class="w"> </span><span class="n">enc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CFStringBuiltInEncodings</span><span class="p">.</span><span class="na">EncodingUTF8</span><span class="p">;</span>
<span class="n">CFStringRef</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CFStringCreateFromExternalRepresentation</span><span class="p">(</span>
<span class="w">                </span><span class="n">kCFAllocatorDefault</span><span class="p">(),</span><span class="w"> </span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">enc</span><span class="p">);</span>

<span class="c1">// Release the data</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">cf</span><span class="p">);</span>

<span class="c1">// Get the first 10 characters</span>
<span class="n">CharPtr</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PtrFactory</span><span class="p">.</span><span class="na">newCharArray</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">CFStringGetCharacters</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CFRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;First 10 chars are &#39;&quot;</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span>

<span class="c1">// Release the string</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
</pre></div>
</div>
<p>Output will probably be something like <code class="docutils literal notranslate"><span class="pre">First</span> <span class="pre">10</span> <span class="pre">chars</span> <span class="pre">are</span> <span class="pre">'&lt;!DOCTYPE</span> <span class="pre">'</span></code></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The casted object will NOT be automatically retained, as mentioned earlier, memory management for those objects require manual retaining and releasing!</p>
</div>
</section>
<section id="c-to-objective-c">
<h2>C to Objective-C<a class="headerlink" href="#c-to-objective-c" title="Link to this heading">¶</a></h2>
<p>As you would have guessed properly, sometimes there is the need to do the opposite, convert CoreFoundation types to Foundation classes. This also can be done with the <code class="docutils literal notranslate"><span class="pre">ObjCRuntime.cast(from,</span> <span class="pre">toType)</span></code> method:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a string containing &#39;http://www.intel.com&#39;</span>
<span class="n">CFStringRef</span><span class="w"> </span><span class="n">urlStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CFStringCreateWithCString</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">(),</span>
<span class="w">                </span><span class="s">&quot;http://www.intel.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CFStringBuiltInEncodings</span><span class="p">.</span><span class="na">EncodingUTF8</span><span class="p">);</span>

<span class="c1">// Create an URL with the string</span>
<span class="n">CFURLRef</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CFURLCreateWithString</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">(),</span><span class="w"> </span><span class="n">urlStr</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">);</span>

<span class="c1">// Release the string</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">urlStr</span><span class="p">);</span>

<span class="c1">// Create a string with the contents of the URL</span>
<span class="n">NSString</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NSString</span><span class="p">.</span><span class="na">stringWithContentsOfURLEncodingError</span><span class="p">(</span>
<span class="w">                </span><span class="n">ObjCRuntime</span><span class="p">.</span><span class="na">cast</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">NSURL</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w"> </span><span class="n">Enums</span><span class="p">.</span><span class="na">NSUTF8StringEncoding</span><span class="p">,</span>
<span class="w">                </span><span class="kc">null</span><span class="p">);</span>

<span class="c1">// Release the URL</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>

<span class="c1">// Get the first 10 characters</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;First 10 chars are &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="na">substringToIndex</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Output will again be something like <code class="docutils literal notranslate"><span class="pre">First</span> <span class="pre">10</span> <span class="pre">chars</span> <span class="pre">are</span> <span class="pre">'&lt;!DOCTYPE</span> <span class="pre">'</span></code></p>
</section>
<section id="c-to-c">
<h2>C to C<a class="headerlink" href="#c-to-c" title="Link to this heading">¶</a></h2>
<p>When using CoreFoundation and other functions in C frameworks, type information might get “lost”. This is because their types mostly don’t contain any runtime type information with them (however for some types type ID’s can be queried). NatJ has ways of re-introducing type information to the Java runtime. This can be done with the <code class="docutils literal notranslate"><span class="pre">CRuntime.cast(from,</span> <span class="pre">toType)</span></code> method:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a dictionary from a CGRect</span>
<span class="n">CFDictionaryRef</span><span class="w"> </span><span class="n">dict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CGRectCreateDictionaryRepresentation</span><span class="p">(</span><span class="n">CGRectZero</span><span class="p">());</span>

<span class="c1">// Get the height info</span>
<span class="n">ConstVoidPtr</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CFDictionaryGetValue</span><span class="p">(</span><span class="n">dict</span><span class="p">,</span>
<span class="w">                </span><span class="n">CFStringCreateWithCString</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Height&quot;</span><span class="p">,</span>
<span class="w">                                </span><span class="n">CFStringBuiltInEncodings</span><span class="p">.</span><span class="na">EncodingUTF8</span><span class="p">));</span>

<span class="c1">// Value has no real Java type information but we know it&#39;s a CFNumberRef</span>
<span class="c1">// Cast &#39;value&#39; to a CFNumberRef</span>
<span class="n">CFNumberRef</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CRuntime</span><span class="p">.</span><span class="na">cast</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">CFNumberRef</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="c1">// Retrieve the raw value from &#39;number&#39;</span>
<span class="n">NFloatPtr</span><span class="w"> </span><span class="n">valuePtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PtrFactory</span><span class="p">.</span><span class="na">newNFloatReference</span><span class="p">();</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CFNumberGetValue</span><span class="p">(</span><span class="n">number</span><span class="p">,</span><span class="w"> </span><span class="n">CFNumberType</span><span class="p">.</span><span class="na">CGFloatType</span><span class="p">,</span><span class="w"> </span><span class="n">valuePtr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Failed to read height&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Height is &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">valuePtr</span><span class="p">.</span><span class="na">get</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">// Release the dictionary</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../working_with_pointers/Working_With_Pointers/" class="btn btn-neutral float-left" title="Working with Pointers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../../7_creating_db_app/creating_db_app/" class="btn btn-neutral float-right" title="Creating a Database App" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Intel Corporation, Migeran &amp; Multi-OS Engine Community.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <header>
  <div class="header__container">
    <a href="http://doc.multi-os-engine.org/" class="header__logo">
      <img width="176" src="../../../../_static/moelogo-02.png">
    </a>
    <div class="links__icon">
      <i class="fa fa-bars"></i>
    </div>
    <ul class="header__links">
      
        <li><a href="https://multi-os-engine.org/">Home</a></li>
        <li><a href="https://multi-os-engine.org/features/">Features</a></li>
        <li><a href="https://doc.multi-os-engine.org">Docs</a></li>
        <li><a href="https://multi-os-engine.org/blog/">Blog</a></li>
        <li><a href="https://multi-os-engine.org/support/">Support</a></li>
        <li><a href="https://discuss.multi-os-engine.org">Forum</a></li>
        <li><a href="https://discord.gg/m5t3qNXTWj">Discord</a></li>
        <li><a href="https://github.com/multi-os-engine/multi-os-engine">GitHub</a></li>
    </ul>
  </div>
</header>


</body>
</html>